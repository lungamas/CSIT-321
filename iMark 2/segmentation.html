<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Segmentation Reporting â€¢ iMark</title>
  <style>
    :root {
      --gradient-dark: #131613;
      --gradient-light: #138C3D;
      --accent: #16A348;
      --grey-bar: #666D66;
      --sidebar: #b8b8b8;
      --glow: #16a348;
      --panel-solid: #D7DBD8;
      --panel-edge: #0f322a;
      --panel-border: #cfd4d1;
      --pill-bg: #F7F9F8;
      --text-dark: #121417;
      --muted: #9aa6a3;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Poppins", Arial, sans-serif;
    }

    body {
      background: linear-gradient(145deg, var(--gradient-dark) 25%, var(--gradient-light) 100%);
      color: #fff;
      min-height: 100vh;
      overflow-x: hidden;
    }

    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 55px;
      background: var(--grey-bar);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 50px;
      gap: 40px;
      z-index: 5;
    }

    header a {
      color: #fff;
      text-decoration: none;
      font-weight: 600;
      transition: color 0.3s;
    }

    header a:hover {
      color: var(--accent);
    }

    header a.active {
      color: var(--accent);
    }

    .sidebar {
      position: fixed;
      top: 55px;
      left: 0;
      bottom: 0;
      width: 230px;
      background: var(--sidebar);
      padding: 25px 20px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      z-index: 6;
      border-top: 4px solid var(--glow);
      border-right: 4px solid var(--glow);
      border-bottom: 4px solid var(--glow);
      border-left: none;
      box-shadow: 5px 0 25px rgba(22, 163, 72, 0.7);
      border-radius: 0 15px 15px 0;
    }

    .logo {
      display: flex;
      justify-content: center;
      margin-bottom: 60px;
    }

    .logo img {
      height: 60px;
      width: auto;
    }

    .nav-links {
      display: flex;
      flex-direction: column;
      gap: 25px;
    }

    .nav-links a {
      color: #fff;
      text-decoration: none;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: color 0.3s;
    }

    .nav-links a:hover {
      color: var(--accent);
    }

    .nav-links img.icon {
      width: 22px;
      height: 22px;
      vertical-align: middle;
    }

    .logout a {
      color: #fff;
      font-weight: bold;
      text-decoration: none;
      transition: color 0.3s;
    }

    .logout a:hover {
      color: var(--accent);
    }

    .bg-logo {
      position: fixed;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 0;
      opacity: 0.15;
      filter: blur(3px);
      pointer-events: none;
    }

    .bg-logo img {
      width: 1500px;
      height: auto;
    }

    main {
      margin-left: 230px;
      margin-top: 55px;
      padding: 60px;
      position: relative;
      z-index: 2;
    }

    h1 {
      text-align: center;
      color: var(--accent);
      margin-bottom: 30px;
      font-size: 32px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .section {
      background: var(--panel-solid);
      border: 1px solid var(--panel-border);
      border-radius: 14px;
      padding: 22px;
      margin-bottom: 22px;
      box-shadow: 0 2px 0 0 var(--panel-edge) inset, 0 10px 16px rgba(0, 0, 0, 0.35);
      color: var(--text-dark);
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 14px;
      color: var(--text-dark);
    }

    .section-title img {
      width: 32px;
      height: 32px;
    }

    h2 {
      font-size: 20px;
      margin: 0;
      line-height: 1.1;
    }

    .upload-pill {
      background: var(--pill-bg);
      border-radius: 12px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #1b1b1b;
      font-weight: 700;
      letter-spacing: 0.01em;
      box-shadow: 0 1px 0 rgba(0, 0, 0, 0.06) inset;
      cursor: pointer;
      position: relative;
    }

    .upload-pill input[type=file] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .upload-pill img {
      width: 18px;
      height: 18px;
      margin-right: 10px;
      opacity: 0.9;
    }

    .helper {
      font-size: 13px;
      color: var(--muted);
      margin-top: 8px;
    }

    textarea {
      width: 100%;
      height: 160px;
      border-radius: 12px;
      border: none;
      padding: 16px;
      font-size: 14px;
      outline: none;
      resize: none;
      background: #ffffff;
      color: #1b1b1b;
      box-shadow: 0 1px 0 rgba(0, 0, 0, 0.06) inset;
    }

    .actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-top: 16px;
    }

    .btn-primary {
      flex: 1;
      background: linear-gradient(180deg, #37b45c, #1e8f45);
      border: none;
      color: #fff;
      padding: 14px 20px;
      border-radius: 14px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.35);
      transition: transform 0.15s ease, filter 0.2s ease;
    }

    .btn-primary:hover {
      filter: brightness(1.06);
      transform: translateY(-1px);
    }

    .btn-ghost {
      background: #ffffff;
      color: #1f2a1f;
      border: none;
      border-radius: 12px;
      padding: 12px 18px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.25);
    }

    .btn-ghost a {
      color: inherit;
      text-decoration: none;
      display: block;
    }

    .btn-ghost:hover {
      filter: brightness(0.98);
    }

    footer {
      position: fixed;
      bottom: 15px;
      right: 20px;
      font-size: 12px;
      color: #ccc;
      letter-spacing: 0.03em;
    }

    .preset-container {
      margin-top: 4px;
    }

    .preset-hint {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .preset-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .preset-option {
      width: 100%;
      text-align: left;
      background: var(--pill-bg);
      border-radius: 10px;
      border: 1px solid var(--panel-border);
      padding: 10px 12px;
      font-size: 14px;
      color: var(--text-dark);
      cursor: pointer;
      display: flex;
      align-items: flex-start;
      gap: 8px;
      transition: background 0.2s, border-color 0.2s, transform 0.1s;
    }

    .preset-option::before {
      content: "";
      width: 9px;
      height: 9px;
      margin-top: 5px;
      border-radius: 999px;
      border: 2px solid var(--muted);
      background: transparent;
      flex-shrink: 0;
    }

    .preset-option span {
      flex: 1;
    }

    .preset-option:hover {
      background: #e7ece9;
      transform: translateY(-1px);
    }

    .preset-option.selected {
      background: linear-gradient(135deg, var(--accent), #0f7f33);
      color: #f9fff9;
      border-color: #5ee58c;
      transform: translateY(-1px);
    }

    .preset-option.selected::before {
      border-color: #bbf7d0;
      background: #bbf7d0;
    }

    .prompt-error {
      margin-top: 8px;
      font-size: 13px;
      color: #fca5a5; 
      display: none;
    }

    /* ML Segments Overview table */
    .segments-table-wrapper {
      margin-top: 12px;
      overflow-x: auto;
    }

    .segments-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      background: #f5f7f5;
      border-radius: 12px;
      overflow: hidden;
    }

    .segments-table thead {
      background: #e2e6e3;
    }

    .segments-table th,
    .segments-table td {
      padding: 8px 10px;
      text-align: left;
      border-bottom: 1px solid #d0d4d1;
      white-space: nowrap;
    }

    .segments-table tr:last-child td {
      border-bottom: none;
    }

    .segments-table th {
      font-weight: 600;
      color: #1b1b1b;
    }

    .segments-table td {
      color: #333;
    }
  </style>
</head>
<body>
  <header>
    <a href="index.html" target="_self">Home</a>
    <a href="services.html" class="active" target="_self">Services</a>
    <a href="help.html" target="_self">Help</a>
    <a href="policy.html" target="_self">Privacy policy</a>
  </header>

  <aside class="sidebar">
    <div>
      <div class="logo"><img src="iMark.png" alt="iMark logo" /></div>
      <div class="nav-links">
        <a href="dashboard.html" target="_self">
          <img src="dashboard.png" class="icon" alt="Dashboard icon"> Dashboard
        </a>
        <a href="insights.html" target="_self">
          <img src="insights.png" class="icon" alt="Insights icon"> Previous Insights
        </a>
      </div>
    </div>
    <div class="logout"><a href="home.html" target="_self">Logout</a></div>
  </aside>

  <div class="bg-logo"><img src="iMark.png" alt="background logo" /></div>

  <main>
    <h1>Segmentation Reporting</h1>

    <section class="section">
      <div class="section-title">
        <img src="about.png" alt="About icon">
        <h2>About This Feature</h2>
      </div>
      <p>
        The Segmentation Report AI analyzes customer data to define behavioral patterns,
        identify audience segments, and generate detailed personas. Upload your customer
        data and provide a prompt to get started.
      </p>
    </section>

    <section class="section">
      <div class="section-title">
        <img src="upload.png" alt="Upload icon">
        <h2>Upload Files</h2>
      </div>

      <label class="upload-pill">
        <img src="upload.png" alt="Upload Icon"> Browse Device
        <input type="file" id="fileUpload" accept=".csv,.xlsx,.json" />
      </label>
      <p class="helper">Supported formats: CSV, XLSX, JSON</p>
    </section>

    <section class="section">
      <div class="section-title">
        <img src="prompt.png" alt="Prompt icon">
        <h2>Prompt Task</h2>
      </div>

      <div class="preset-container">
        <p class="preset-hint">Select the type of insight you want iMark to generate:</p>
        <div class="preset-list" id="presetList">
          <button type="button" class="preset-option" data-value="Segment customers based on purchasing behavior patterns.">
            <span>Segment customers based on purchasing behavior patterns.</span>
          </button>
          <button type="button" class="preset-option" data-value="Recommend optimized target audience groups for campaigns.">
            <span>Recommend optimized target audience groups for campaigns.</span>
          </button>
          <button type="button" class="preset-option" data-value="Analyze demographic and engagement data to identify key audience segments.">
            <span>Analyze demographic and engagement data to identify key audience segments.</span>
          </button>
        </div>
      </div>

      <div class="actions">
        <button class="btn-primary" type="button" id="generateBtn">Generate Insights</button>
        <button class="btn-ghost" type="button">
          <a href="segmentation.html" target="_self">New Insight</a>
        </button>
      </div>

      <p id="promptError" class="prompt-error">
        Please select one of the options above before generating insights.
      </p>
    </section>

    <!-- Result section -->
    <section class="section" id="resultSection" style="display: none; margin-top: 22px;">
      <div class="section-title">
        <img src="insights.png" alt="Result icon">
        <h2>Generated Segmentation Insight</h2>
      </div>
      <div id="resultContent"></div>
    </section>

    <!-- NEW: ML Segments Overview -->
    <section class="section" id="segmentsOverviewSection" style="display:none; margin-top: 12px;">
      <div class="section-title">
        <img src="insights.png" alt="Segments icon">
        <h2>Segments Overview (ML)</h2>
      </div>

      <p class="helper" id="segmentsTotalLine"></p>

      <div class="segments-table-wrapper">
        <table class="segments-table">
          <thead>
            <tr>
              <th>Segment</th>
              <th>Customers</th>
              <th>% of Total</th>
              <th>Avg Age</th>
              <th>Avg Monthly Spend</th>
              <th>Avg Orders / Month</th>
              <th>Avg Visits / Month</th>
              <th>Pref. Score</th>
            </tr>
          </thead>
          <tbody id="segmentsTableBody">
            <!-- Filled by JS -->
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <footer>POWERED BY NULL SPACE</footer>

  <script>
    const presetButtons = document.querySelectorAll('.preset-option');
    const generateBtn = document.getElementById('generateBtn');
    const promptError = document.getElementById('promptError');
    const fileInput = document.getElementById('fileUpload');
    const resultSection = document.getElementById('resultSection');
    const resultContent = document.getElementById('resultContent');

    const segmentsOverviewSection = document.getElementById('segmentsOverviewSection');
    const segmentsTotalLine = document.getElementById('segmentsTotalLine');
    const segmentsTableBody = document.getElementById('segmentsTableBody');

    let selectedPrompt = "";

    // Render ML segments overview (from backend insight.details)
    function renderSegmentsOverview(details) {
      if (
        !details ||
        !details.segments ||
        !Array.isArray(details.segments) ||
        !details.segments.length
      ) {
        segmentsOverviewSection.style.display = "none";
        segmentsTableBody.innerHTML = "";
        segmentsTotalLine.textContent = "";
        return;
      }

      const total =
        details.totalCustomers ??
        details.total_customers ??
        0;

      segmentsOverviewSection.style.display = "block";
      segmentsTotalLine.textContent =
        `Total customers analyzed by the model: ${total}`;

      segmentsTableBody.innerHTML = "";

      details.segments.forEach(seg => {
        const tr = document.createElement("tr");

        const label = seg.label || `Segment ${seg.cluster}`;
        const count = seg.count ?? "";
        const percentage =
          seg.percentage != null ? `${seg.percentage}%` : "";

        const avgAge = seg.avg_age ?? "";
        const avgSpend = seg.avg_monthly_spend ?? "";
        const avgOrders = seg.avg_orders_per_month ?? "";
        const avgVisits = seg.avg_visits_per_month ?? "";
        const prefScore =
          seg.avg_category_preference_score ?? "";

        tr.innerHTML = `
          <td>${label}</td>
          <td>${count}</td>
          <td>${percentage}</td>
          <td>${avgAge}</td>
          <td>${avgSpend}</td>
          <td>${avgOrders}</td>
          <td>${avgVisits}</td>
          <td>${prefScore}</td>
        `;

        segmentsTableBody.appendChild(tr);
      });
    }

    // keep your existing selection behavior, plus store the prompt text
    presetButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        presetButtons.forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        promptError.style.display = 'none';
        selectedPrompt = btn.dataset.value || btn.textContent.trim();
      });
    });

    generateBtn.addEventListener('click', async () => {
      const user = JSON.parse(localStorage.getItem('imarkUser') || 'null');
      const userId = user ? user.id : null;

      const selected = document.querySelector('.preset-option.selected');
      if (!selected) {
        promptError.style.display = 'block';
        return;
      }
      promptError.style.display = 'none';

      // hide old ML table while loading a new one
      renderSegmentsOverview(null);

      // 1) Optional: upload file if chosen
      let fileId = null;
      if (fileInput && fileInput.files && fileInput.files[0]) {
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('fileType', 'segmentation');
        if (userId) formData.append('userId', userId);

        try {
          const uploadRes = await fetch('/api/upload', {
            method: 'POST',
            body: formData
          });
          const uploadData = await uploadRes.json();
          if (uploadRes.ok) {
            fileId = uploadData.file.id;
          }
        } catch (e) {
          console.error('Upload failed (continuing anyway)', e);
        }
      }

      // 2) Call backend AI endpoint
      try {
        const res = await fetch('/api/ai/segmentation', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId,
            prompt: selectedPrompt,
            fileId
          })
        });

        const data = await res.json();
        if (!res.ok) {
          alert(data.message || 'Error generating insight.');
          renderSegmentsOverview(null);
          return;
        }

        const insight = data.insight;
        const details = insight.details;

        // 3) Render personas + summary
        resultSection.style.display = 'block';
        resultContent.innerHTML = `
          <p><strong>Title:</strong> ${insight.title}</p>
          <p><strong>Summary:</strong> ${insight.summary}</p>
          <p><strong>Prompt used:</strong> ${details.promptUsed}</p>
          <hr style="margin: 12px 0;" />
          ${details.personas
            .map(
              p => `
            <div style="margin-bottom: 12px;">
              <h3 style="margin-bottom: 4px;">${p.name}</h3>
              <p>${p.description}</p>
              <p><strong>Key signals:</strong> ${p.keySignals.join(', ')}</p>
              <p><strong>Suggested channels:</strong> ${p.suggestedChannels.join(', ')}</p>
            </div>
          `
            )
            .join('')}
        `;

        // 4) Render ML segments table
        renderSegmentsOverview(details);
      } catch (err) {
        console.error(err);
        alert('Server error. Make sure backend is running.');
        renderSegmentsOverview(null);
      }
    });
  </script>
</body>
</html>
